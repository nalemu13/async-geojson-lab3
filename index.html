<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="utf-8" />
  <title>My Two-Layer Web Map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://unpkg.com/maplibre-gl@^5.9.0/dist/maplibre-gl.js"></script>
  <link href="https://unpkg.com/maplibre-gl@^5.9.0/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    html, body { margin:0; padding:0; }
    #container { display:flex; height:100vh; }
    #side-panel { flex-basis:420px; overflow-y:auto; padding:16px; background:rgba(255,255,255,.95); }
    #map { flex-grow:1; }
    h2 { margin:0 0 8px 0; }
    button { margin:8px 0 12px 0; cursor:pointer; }
    table { border-collapse:collapse; width:100%; border:1px solid #ddd; }
    th, td { text-align:left; padding:10px; }
    tr:nth-child(even) { background:#f6f6f6; }
    @media (max-width:1024px){ #side-panel { display:none; } }
  </style>
</head>
<body>
  <main id="container">
    <div id="side-panel">
      <h2>Major U.S. Cities</h2>
      <button id="sort-btn">Sort by Population</button>
      <table id="list-table">
        <tr><th>Name</th><th>Capacity</th><th>Type</th></tr>
      </table>
    </div>
    <div id="map"></div>
  </main>

  <script>
    // OpenStreetMap raster basemap
    const map = new maplibregl.Map({
      container: 'map',
      center: [-122.33, 47.61],
      zoom: 10,
      style: {
        "version": 8,
        "sources": {
          "osm": {
            "type": "raster",
            "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
            "tileSize": 256,
            "attribution": "Â© OpenStreetMap contributors"
          }
        },
        "layers": [{ "id":"osm", "type":"raster", "source":"osm" }]
      }
    });

    async function geojsonFetch(){
      // filenames must match your assets exactly
      const ptsResp  = await fetch('assets/points.geojson');
      const points   = await ptsResp.json();
      const polyResp = await fetch('assets/polygons.geojson');   // <-- fixed name
      const polys    = await polyResp.json();

      map.on('load', () => {
        // Polygons
        map.addSource('polys', { type:'geojson', data: polys });
        map.addLayer({
          id:'polys-fill', type:'fill', source:'polys',
          paint:{ 'fill-color':'#22a7f0', 'fill-opacity':0.35 }
        });
        map.addLayer({
          id:'polys-outline', type:'line', source:'polys',
          paint:{ 'line-color':'#116fa3', 'line-width':1 }
        });

        // Points (color by 'capacity')
        map.addSource('points', { type:'geojson', data: points });
        map.addLayer({
          id:'points', type:'circle', source:'points',
          paint:{
            'circle-radius':6,
            'circle-stroke-width':1.5,
            'circle-stroke-color':'#fff',
            'circle-color': ['interpolate', ['linear'], ['get','capacity'],
              0, '#56b881', 800000, '#e67e22', 2000000, '#e74c3c'
            ]
          }
        });

        // Popups
        map.on('click', 'points', (e) => {
          const p = e.features[0].properties;
          new maplibregl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(`<strong>${p.name ?? 'Feature'}</strong><br>Type: ${p.type ?? 'n/a'}<br>Capacity: ${p.capacity ?? 'n/a'}`)
            .addTo(map);
        });
        map.on('mouseenter','points',()=>map.getCanvas().style.cursor='pointer');
        map.on('mouseleave','points',()=>map.getCanvas().style.cursor='');
      });

      // Build the table using name / capacity / type
      const table = document.getElementById('list-table');
      for (const f of points.features){
        const r = table.insertRow(-1);
        r.insertCell(0).innerText = f.properties.name ?? '(no name)';
        r.insertCell(1).innerText = f.properties.capacity ?? '';
        r.insertCell(2).innerText = f.properties.type ?? '';
      }

      // Sort by Capacity (descending)
      document.getElementById('sort-btn').addEventListener('click', () => {
        let switching = true;
        while (switching) {
          switching = false;
          const rows = table.rows;
          for (let i=1; i<rows.length-1; i++){
            const x = parseFloat(rows[i].cells[1].innerText) || -Infinity;
            const y = parseFloat(rows[i+1].cells[1].innerText) || -Infinity;
            if (x < y) { rows[i].parentNode.insertBefore(rows[i+1], rows[i]); switching = true; break; }
          }
        }
      });
    }
    geojsonFetch();
  </script>
</body>
</html>
